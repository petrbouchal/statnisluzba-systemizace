---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ""
)
```

```{r, echo = FALSE}
targets::tar_load(syst_all)
targets::tar_load(syst_pocty_long)
targets::tar_load(orgdata_graph)
targets::tar_load(orgdata_nodes_processed)
targets::tar_load(orgdata_edges_processed)
targets::tar_load(orgdata_rect)
source("_targets_packages.R")
```

```{r}
cnf <- config::get()
nms_orig <- names(cnf)
names(cnf) <- paste0("c_", names(cnf))
list2env(cnf, envir = .GlobalEnv)
names(cnf) <- names(nms_orig)
rm(nms_orig)
```


# systemizace

<!-- badges: start -->
<!-- badges: end -->

This repository contains R code to download and process official data on the organisation of public servants in the Czech central public administration - "systemizace služebních míst".

It works with two sources of data:

1. The official tables
2. Organisational structures published as [open data](https://data.gov.cz/datov%C3%A1-sada?iri=https%3A%2F%2Fdata.gov.cz%2Fzdroj%2Fdatov%C3%A9-sady%2F00007064%2F846439662)

### Official tables

The code downloads, loads and processes the published excel files such that

- the data is in tidy format
- civil servants and employees are in one data frame
- pay grades (platové třídy) and management levels (představení) are correctly identified

See https://www.mvcr.cz/sluzba/clanek/systemizace-sluzebnich-a-pracovnich-mist.aspx. For [April 2022 edition](https://www.mvcr.cz/sluzba/clanek/zmena-systemizace-sluzebnich-a-pracovnich-mist-s-ucinnosti-od-1-dubna-2022.aspx), only PDF table is provided.

Data currently available from `r min(syst_all$rok)` to `r max(syst_all$rok)`.

#### Sample

```{r}
syst_pocty_long |>
  dplyr::filter(ustredni_organ, kapitola_vladni) |>
  mutate(trida = as.integer(trida)) |>
  group_by(rok, kapitola_zkr, level_nazev) |>
  drop_na(pocet) |>
  dplyr::filter(date == "2022-04-01") |>
  summarise(trida_mean = weighted.mean(trida, w = pocet, na.rm = TRUE), 
            .groups = "drop") |>
  mutate(kapitola_zkr = as.factor(kapitola_zkr) |> fct_reorder(trida_mean, min)) |>
  ggplot(aes(trida_mean, kapitola_zkr, colour = level_nazev)) +
  geom_point(size = 3) +
  scale_color_manual(name = "Úroveň řízení", values = c("grey50", "darkblue")) +
  scale_x_continuous(limits = c(10, 15)) +
  ptrr::theme_ptrr("both", multiplot = FALSE, legend.position = "top") +
  labs(title = "Průměrná platová třída (2022)",
       subtitle = "Podle systemizace 2022.\nJen ústřední orgány ve vládních kapitolách",
       caption = "Plánovaný stav podle systemizace 2022")
```


Wide format

```{r}
syst_all
```

Long format - staff numbers only

```{r}
syst_pocty_long
```



### Organisational structures

This data is published as one large XML file for all "služební úřady", i.e. organisations governed by Služební zákon, the Civil Service Act. It lists all organisational units within these organisations along their unique and internal IDs, names, parents (subordinate) units and staff counts (service an contract roles).

In practice:

- some ministries do not break down their units to the lowest level (MZV and MV leave out the bottom level)
- names and abbrevietations are inputted differently by different orgs - some list include numbers, some names are in fact abbreviations etc., which makes text searching difficult
- staff counts are missing for most orgs and undocumented, i.e. it is not clear whether it is actual contracts (occupied slots) or slots regardless of whether they are occupied; also not clear if it is FTEs or headcount/position counts.

The code here transforms that data into

- a graph and its components (nodes and edges) which forms a tree. This can be analysed in R via packages that can work with graphs (e.g. tidygraph, ggraph) or in other tools using the tables of nodes and edges (visNetwork)
- a hierarchical table, listing all units, where each row denotes a units lowest in the hierarchy and columns list all its parents, one level per column. This is useful for search or for visualisation using e.g. D3network, tree mark in Observable Plot or the CollapsibleTree package.

This data is exported as CSV in `r c_export_dir`

For more info on data on public servants see [recent report](https://idea.cerge-ei.cz/zpravy/statni-zamestnanci-a-urednici-kde-pracuji-a-za-kolik) and [related repo](https://github.com/dan-bart/urednici_2021), plus an [older overview of available sources](https://petrbouchal.xyz/urednici/).

#### Preview

```{r}
orgdata_graph |>
  activate(nodes) |>
  # mutate(xx = node_distance_to(nazev %in% c("odd.zákl.vzd."))) |>
  dplyr::filter(nazev != "nic", urad_zkratka == "GFŘ") |>
  # ggraph("star") +
  ggraph("kk") +
  geom_node_point(aes(size = child_ftes)) +
  geom_edge_diagonal0() +
  geom_node_label(aes(label = zkratka), vjust = "outward") +
  scale_x_reverse()
```


Graph

```{r}
orgdata_graph
```

Nodes

```{r}
orgdata_nodes_processed
```

Edges

```{r}
orgdata_edges_processed
```

Table

```{r}
orgdata_rect
```



### Technical: how to run this

Code organised as a {targets} pipeline, with packages tracked by {renv}, so can be reproduced like so:

```r
renv::restore()
targets::tar_make()
```

Tidy data ready for analysis are in `data-export`. Codebook is TBA.

Rendered `r Sys.time()`
